name: Expire Demo Repository

on:
  schedule:
    - cron: "17 3 * * *"
  workflow_dispatch:

permissions: write-all

jobs:
  expire:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Read expiration from deploy_all.sql
        id: expiry
        run: |
          python - <<'PY'
          import os
          import pathlib
          import re
          import sys

          text = pathlib.Path("deploy_all.sql").read_text(encoding="utf-8")
          m = re.search(r"^\\s*\\*\\s*EXPIRES:\\s*(\\d{4}-\\d{2}-\\d{2})\\s*$", text, flags=re.M)
          if not m:
            print("ERROR: Could not find a line like '* EXPIRES: YYYY-MM-DD' in deploy_all.sql", file=sys.stderr)
            sys.exit(1)

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"expires={m.group(1)}\\n")
          PY

      - name: Determine whether repository is expired
        id: check
        run: |
          set -euo pipefail
          TODAY="$(date -u +%F)"
          EXPIRES="${{ steps.expiry.outputs.expires }}"
          echo "today=$TODAY" >> "$GITHUB_OUTPUT"
          echo "expires=$EXPIRES" >> "$GITHUB_OUTPUT"
          if [[ "$TODAY" > "$EXPIRES" ]]; then
            echo "expired=true" >> "$GITHUB_OUTPUT"
          else
            echo "expired=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Archive repository (expired)
        if: steps.check.outputs.expired == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            core.info(`Repository expired. Archiving ${owner}/${repo}...`);
            await github.rest.repos.update({ owner, repo, archived: true });

      - name: Make repository private (expired)
        if: steps.check.outputs.expired == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            core.info(`Repository expired. Making ${owner}/${repo} private...`);
            await github.rest.repos.update({ owner, repo, private: true });
